\documentclass{ctexbook}

\usepackage{boxedminipage2e}
\usepackage{csquotes}
\usepackage{xltxtra,mflogo,texnames}
\usepackage{geometry}
\usepackage[colorlinks]{hyperref}

\usepackage[backend=biber,
            style=gb7714-2015ay,
            sortlocale=zh__pinyin,
            gbtype=false,
            maxbibnames=99,% 著录所有作者
            maxcitenames=2,% 引用标注中最多显示2个作者
            mincitenames=1,% 3个及3个以上的作者截断为1个作者
            %gbnamefmt=lowercase,% 姓名大小写由输出定
            %gbnamefmt=pinyin,
            gbnamefmt=familyahead,
            %url=false,
            doi=false,
            isbn=false,
            gbfieldtype=true,
            gbpunctin=false,
            ]{biblatex}

\hypersetup{
     %colorlinks   = true,
     citecolor    = black
}
            
% \DeclareFieldFormat{citehyperref}{%
%    \DeclareFieldAlias{bibhyperref}{noformat}% Avoid nested links
%    \bibhyperref{#1}}  
 
           
\makeatletter
%\def\bibrangedash{$\sim$}% 表示范围的波浪线符号
\DefineBibliographyExtras{english}{\renewcommand*{\bibrangedash}{$\sim$}}
%\newcommand\nwafubibfont{\linespread{1.0}\zihao{-5}}% 字体
\newcommand\nwafubibfont{\zihao{-5}}% 字体

\renewcommand{\bibfont}{\nwafubibfont}% 全局字体设置

\DeclareFieldFormat[article]{journaltitle}{\iffieldequalstr{userd}{chinese}{#1}{\textit{#1}}\isdot}% 英文刊名用斜体

\renewcommand{\postnotedelim}{\addcolon\addspace}
\renewcommand*{\nameyeardelim}{\addspace}
\DeclareDelimFormat[bib,biblist]{nameyeardelim}{\addperiod\space}
\DeclareFieldFormat{postnote}{#1}

\DefineBibliographyStrings{english}{
    %and         = {\addcomma},%将第2和3人名见的and符号改成 逗号，用\finalnamedelim命令也可以定义，参见3.9.1节
    %andcn       = {\addcomma},%\str@andcn\ and本地化字符串的中文对应词
    andincitecn = {和},%将标注中的分开，便于与文献表中的区分
    andincite   = {and},
    mathesiscn={[硕士学位论文]},
    phdthesiscn={[博士学位论文]},
    in={In:\addspace},
    incn={见:\addspace},
}

% “和”与“and”前后的空格调整
\DeclareDelimFormat{finalnamedelim}{%
  \ifnumgreater{\value{liststop}}{2}{\finalandcomma}{}%
  %\addspace%
  \edef\userfieldabcde{userd}%
  \ifcurrentname{translator}{\edef\userfieldabcde{usere}}{}%
  \ifcurrentname{editor}{\edef\userfieldabcde{userc}}{}%
  \ifcurrentname{author}{\edef\userfieldabcde{userf}}{}%
  \ifcurrentname{bookauthor}{\edef\userfieldabcde{userb}}{}%
  \ifcase\value{gbcitelocalcase}%
    \iffieldequalstr{\userfieldabcde}{chinese}{\bibstring{andincitecn}}{}%
    \iffieldequalstr{\userfieldabcde}{korean}{\bibstring{andkr}}{}%
    \iffieldequalstr{\userfieldabcde}{japnese}{\bibstring{andjp}}{}%
    \iffieldequalstr{\userfieldabcde}{english}{\addspace\bibstring{andincite}\addspace}{}%
    \iffieldequalstr{\userfieldabcde}{french}{\addspace\bibstring{and}\addspace}{}%
    \iffieldequalstr{\userfieldabcde}{russian}{\addspace\bibstring{and}\addspace}{}%
  \or%
  \bibstring{andincitecn}%
  \or%
  \addspace\bibstring{andincite}\addspace%
  \fi
}

%----------------------------------------------------------------------
%
% -new added  20190215， 胡时栋
% 去掉超过3个著者时汉字“等”前的空格
\DeclareDelimFormat{strandothersdelim}{%
  \ifnumgreater{\value{liststop}}{2}{\finalandcomma}{}%
  %\addspace%
  \edef\userfieldabcde{userd}%
  \ifcurrentname{translator}{\edef\userfieldabcde{usere}}{}%
  \ifcurrentname{editor}{\edef\userfieldabcde{userc}}{}%
  \ifcurrentname{author}{\edef\userfieldabcde{userf}}{}%
  \ifcurrentname{bookauthor}{\edef\userfieldabcde{userb}}{}%
  \ifcase\value{gbcitelocalcase}%
    \iffieldequalstr{\userfieldabcde}{chinese}{\bibstring{andothersincitecn}}{}%中文已经通过english本地化字符串定义
    \iffieldequalstr{\userfieldabcde}{korean}{\bibstring{andotherskr}}{}%韩语未定义，所以与bib中一致
    \iffieldequalstr{\userfieldabcde}{japnese}{\bibstring{andothersjp}}{}%日与同韩语
    \iffieldequalstr{\userfieldabcde}{english}{\bibstring{andothersincite}}{}%英语已定义
    \iffieldequalstr{\userfieldabcde}{french}{\bibstring{andothers}}{}%法语未定义，若要定义需要针对french本地化字符串定义
    \iffieldequalstr{\userfieldabcde}{russian}{\bibstring{andothers}}{}%俄语未定义，若要定义需要针对russian本地化字符串定义
  \or%
  \bibstring{andothersincitecn}%
  \or%
  \bibstring{andothersincite}%
  \fi
}

% 之所以不用\DeclareDelimFormat{andothersdelim}{}这样的设置是因为
% gb7714-2015中为兼容老版本的biblatex做的处理就是这样的
% 所以用相同的方式
\AtEveryCitekey{%
  \iffieldequalstr{userf}{chinese}{\renewcommand*{\andothersdelim}{}}%\addthinspace
  {\renewcommand*{\andothersdelim}{\addspace}}%
}

% 标注压缩时，直接用date+extradate代替extradate实现2006a，2006b的效果
\newbibmacro*{cite:extradate}{%
  \iffieldundef{extradate} {}
  {\printtext[bibhyperref]{\printlabeldateextra}}%\printfield{extradate}
}

% 文献表中的日期格式
\renewbibmacro*{date+extradate}{%
  \iffieldundef{labelyear}{}%
  {\ifboolexpr{%
      test {\ifentrytype{patent}}
      or
      (test {\ifentrytype{newspaper}})%
    }%
    {\printtext{\blx@isodate{}{}}}%
    {\printtext{%
        \iflabeldateisdate {\printdateextra} {\printlabeldateextra}}}%
  }%
}
%
% url和url日期格式
%
\renewbibmacro*{url+urldate}{%
  % \usebibmacro{url}%%更换url的位置，放到下面
  \usebibmacro{url}%
  \iffieldundef{urlyear}%
  {}
  {%\setunit*{\addspace}%
    \usebibmacro{urldate}
  }
}

\DeclareFieldFormat{addnumflag}{%
  \ifentrytype{newspaper}
  {\setunit{\addcomma\addspace}\printtext{#1}}
  {\nobreak\printtext{(}\nobreak #1\nobreak\printtext{)}}
}
%
%   重设专利title的输出，将文献类型标识符输出出去
%
\newbibmacro*{patenttitle}{%原输出来自biblatex.def文件
  \ifboolexpr{%
    test{\iffieldundef{title}}%
    and%
    test{\iffieldundef{subtitle}}%
  }%
  {}%
  {
    \printtext[title]{\bibtitlefont%
    \printfield[titlecase]{title}%
    \ifboolexpr{test {\iffieldundef{subtitle}}}%这里增加了对子标题的判断，解决不判断多一个点的问题
    {}
    {
      \setunit{\subtitlepunct}%
      \printfield[titlecase]{subtitle}}%
      \iffieldundef{titleaddon}{}%判断一下titleaddon，否则直接加可能多一个空格
      {\setunit{\subtitlepunct}\printfield{titleaddon}}%
      \setunit{\adddot\addspace}\printfield{number}%写专利号
      \iftoggle{bbx:gbtype}{\printfield[gbtypeflag]{usera}}{}%
     %\iffieldundef{booktitle}{\newunit}{}%当title是析出时，不要标点
     %\newunit
    }%
  }%
}
%
%   在线文献驱动
%
\DeclareBibliographyDriver{online}{%源来自standard.BBX
  \usebibmacro{bibindex}%
  \usebibmacro{begentry}%
  \usebibmacro{author/editor+others/translator+others}%
  \ifnameundef{author}{}{\setunit{\labelnamepunct}\newblock}%这一段用于去除作者不存在时多出的标点
  \usebibmacro{title}%
  \iftoggle{bbx:gbstrict}{}{%
    \newunit%
    \printlist{language}%
    \newunit\newblock
    \usebibmacro{byauthor}%
    \newunit\newblock
    \usebibmacro{byeditor+others}%
    \newunit\newblock
    \printfield{note}
  }%
  \newunit
  \printfield{version}%
  \newunit\newblock
  % \printlist{organization}%
  \printlist{institution}%
  \newunit\newblock
  \ifboolexpr{%
    test{\iffieldundef{day}}
    and
    test{\iffieldundef{endday}}
    and
    test{\iffieldundef{eventday}}%
  }{\usebibmacro{date}}%
  %{\usebibmacro{modifydate}}%修改或更新日期，为带括号的时间
  \usebibmacro{url+urldate}%从下面移上来
  \newunit\newblock
  \iftoggle{bbx:eprint}
    {\usebibmacro{eprint}}
    {}%
  \newunit\newblock
  %\usebibmacro{url+urldate}%
  %\newunit\newblock
  \usebibmacro{addendum+pubstate}%
  \setunit{\bibpagerefpunct}\newblock
  \usebibmacro{pageref}%
  \newunit\newblock
  \iftoggle{bbx:related}
  {
    \usebibmacro{related:init}%
    \usebibmacro{related}
  }
  {}%
  \usebibmacro{finentry}
}
%
%   专利文献驱动
%
\DeclareBibliographyDriver{patent}{%源来自standard.BBX
  \usebibmacro{bibindex}%
  \usebibmacro{begentry}%
  \usebibmacro{author}%
  \ifnameundef{author}{}{\setunit{\labelnamepunct}\newblock}%这一段用于去除作者不存在时多出的标点
  %\usebibmacro{title}%
  \usebibmacro{patenttitle}%给出专利专用的标题输出
  \iftoggle{bbx:gbstrict}{}{%
    \newunit%
    \printlist{language}%
    \newunit\newblock
    \usebibmacro{byauthor}
  }%
  \newunit\newblock
  \printfield{type}%
  \setunit*{\addspace}%
  %\printfield{number}%已放到patenttitle中处理
  \iflistundef{location}
  {}
  {
    \setunit*{\addspace}%
    \printtext{%[parens]
      \printlist[][-\value{listtotal}]{location}
    }
  }%
  \newunit\newblock
  \usebibmacro{byholder}%
  \newunit\newblock
  \printfield{note}%
  \newunit\newblock
  %\usebibmacro{newsdate}%
  %\newunit\newblock
  \usebibmacro{doi+eprint+url}%
  \newunit\newblock
  \usebibmacro{addendum+pubstate}%
  \setunit{\bibpagerefpunct}\newblock
  \usebibmacro{pageref}%
  \newunit\newblock
  \iftoggle{bbx:related}
  {
    \usebibmacro{related:init}%
    \usebibmacro{related}
  }
  {}%
  \usebibmacro{finentry}
}

%----------------------------------------------------------------------

\setlength{\bibitemsep}{2pt}%0ex
\setlength{\bibnamesep}{0ex}
\setlength{\bibinitsep}{0ex}
%\setlength{\bibitemindent}{1.5\ccwd} % bibitemindent表示一条文献中第一行相对后面各行的缩进
%\setlength{\bibhang}{0pt} % 作者年制中 bibhang 表示的各行起始位置到页
                          % 边的距离,顺序编码制中
                          % bibhang+labelnumberwidth 表示各行起始位置
                          % 到页边的距离
\makeatother

%================================================
% 代码呈现环境；listings宏包
% 摘录于：https://github.com/hushidong/biblatex-solution-to-latex-bibliography/blob/master/articlemodelparta.tex
% ================================================
%=====================tikz绘图===============================================
\usepackage{pgf,tikz} %做tikz图所用宏包
\usepgfmodule{shapes}
\usetikzlibrary{arrows,decorations.pathmorphing,backgrounds,positioning,fit,petri}
\usetikzlibrary{math,mindmap,shapes.geometric,calc,intersections,through}
\usetikzlibrary{knots}
%--------------------图表题注--------------------
\usepackage{subfigure}
\usepackage{ccaption}
\newcommand{\listegcodename}{示~~ 例}
\newcommand{\egcodename}{示例}
\newfloatlist{egcode}{loc}{\listegcodename}{\egcodename}
\newfixedcaption{\codecaption}{egcode}

\usepackage{listings}
\lstnewenvironment{texlist}%
{\lstset{% general command to set parameter(s)
%name=#1,
%label=#2,
%caption=\lstname,
linewidth=\linewidth,
breaklines=true,
%showspaces=true,
extendedchars=false,
columns=fullflexible,%flexible,
frame=none,
fontadjust=true,
language=[LaTeX]TeX,
%backgroundcolor=\color{yellow}, %背景颜色
%numbers=left,
%numberstyle=\tiny\color{red},
basicstyle=\footnotesize\ttfamily, % print whole listing small
keywordstyle=\color{blue}\bfseries,%\underbar,
% underlined bold black keywords
identifierstyle=, % nothing happens
commentstyle=\color{green!50!black}, % white comments
stringstyle=\ttfamily, % typewriter type for strings
showstringspaces=false}% no special string spaces
}
{}

\lstnewenvironment{codetex}[2]%
{\begin{center}\end{center}\centering\setlength{\abovecaptionskip}{1mm}\setlength{\belowcaptionskip}{1mm}%
\vspace{-2\baselineskip}
\codecaption{#1}\label{#2}%\nopagebreak
\vspace{-1.0\baselineskip}
\lstset{%general command to set parameter(s)
%name=#1,
%label=#2,
%caption=\lstname,
linewidth=\linewidth,
breaklines=true,
%showspaces=true,
extendedchars=false,
columns=fullflexible,%flexible,
frame=tb,
%frame=none,
fontadjust=true,
language=[LaTeX]TeX,
%backgroundcolor=\color{yellow}, %背景颜色
%backgroundcolor=\color{codebackground},
%fillcolor=\color{codebackground},
rulecolor=\color{green!50!black},
numbers=left,
numberstyle=\tiny\color{red},
basicstyle=\footnotesize\ttfamily, % print whole listing small，footnotesize
keywordstyle=\color{blue}\bfseries,%\underbar,
% underlined bold black keywords
identifierstyle=, % nothing happens
commentstyle=\color{green!50!black}, % white comments
stringstyle=\ttfamily, % typewriter type for strings
showstringspaces=false}% no special string spaces
%\renewcommand{\baselinestretch}{0.95}
\ifodd\thepage{
\begin{tikzpicture}[overlay,remember picture]
\node[fill=yellow!50,inner sep=1pt] at ($(-0.5\linewidth,-2mm)-(4mm,0mm)$) {\tiny{代码}};
\end{tikzpicture}}
\else{
\begin{tikzpicture}[overlay,remember picture]
\node[fill=yellow!50,inner sep=1pt] at ($(0.5\linewidth,-2mm)+(4mm,0mm)$) {\tiny{代码}};
\end{tikzpicture}}
\fi
}{}

% ==============LaTeX命令排版命令========================
\newcommand\cs[1]{\texttt{\textbackslash#1}}
\newcommand{\note}[1]{{%
  \color{magenta}{\bfseries 注意：}\emph{#1}}}

% biblatex宏包的参考文献数据源
\addbibresource[location=local]{sample.bib}

\title{\Large \heiti 信息工程学院本科毕业论文参考文献著录规则}
\author{\zihao{4} \fangsong 耿楠\\\small \songti 西北农林科技大学信息
  工程学院，陕西$\cdot$杨凌，712100}
\date{\today}

\begin{document}
\chapter{参考文献著录说明}

为了进一步规范本科毕业论文的写作，现就我院本科生毕业论文
\enquote{参考文献}引用书写格式规定如下:

\section{引用方式}
参考文献的引用采用\enquote{著者-出版年}制，如：

\section{正文中参考文献的标注}
\subsection{著者作为引用主语}
文中提及著者，在被引用的著者姓名或外国著者姓氏之后用
圆括号标注文献出版年，可使用\cs{textcite}、\cs{yearcite}
命令或手动模式引用文献，如：

\begin{codetex}{著者作引用主语}{code01}
  \textcite{赵耀东1998--}指出...
  赵耀东\yearcite{赵耀东1998--}指出...
  赵耀东(\cite*{赵耀东1998--})指出...
  赵耀东(\citeyear{赵耀东1998--})指出...
\end{codetex}

其排版结果如下：

\begin{center}
  \begin{boxedminipage}{0.8\textwidth}
    \small
    \textcite{赵耀东1998--}指出...

    赵耀东\yearcite{赵耀东1998--}指出...

    赵耀东(\cite*{赵耀东1998--})指出...

    赵耀东(\citeyear{赵耀东1998--})指出...
  \end{boxedminipage}
\end{center}

\note{手动模式使用\cs{cite*}或\cs{citeyear}命令时，需要在两端加上小括
  号。}

\subsection{提及内容未提及著者}

文中只提及所引用的资料内容而未提及著者，则在引文叙述
文字之后用圆括号标注著者姓名或外国著者姓氏和出版年份，在著者
和年份之间空一格，此时可以使用\cs{cite}命令引用文
献，如：

\begin{codetex}{提及内容未提及著者}{code02}
  孟德尔发现了一个很重要的现象，即红、白花豌豆杂交后的所结种子
  第二年长出的植株的红白花比例为3:1\cite{fzx1962}。%
\end{codetex}

其排版结果如下：

\begin{center}
  \begin{boxedminipage}{0.8\textwidth}
    \small
    孟德尔发现了一个很重要的现象，即红、白花豌豆杂交后的所结种子
      第二年长出的植株的红白花比例为3:1\cite{fzx1962}。%
  \end{boxedminipage}
\end{center}

\subsection{同一著者不同年份出版多篇文献}
引用同一著者不同年份出版的多篇文献时，后者只注出版年；
引用同一著者在同一年份出版的多篇文献时，无论正文还是文末，年
份之后用英文小写字母 a、b、c 等加以区别。按年份递增顺序排列,
不同文献之间用逗号隔开。此时可以使用\cs{cite}命令引用文
献，如：

\begin{codetex}{同一著者不同年份出版多篇文献}{code03}
  UML基础和Rose建模教程中给出了大量案例及案例分析\cite{蔡敏2006a--,蔡敏2006b--}。%
\end{codetex}

其排版结果如下：

\begin{center}
  \begin{boxedminipage}{0.9\textwidth}
    \small
    UML基础和Rose建模教程中给出了大量案例及案例分析\cite{蔡敏2006a--,蔡敏2006b--}。%
  \end{boxedminipage}
\end{center}


\subsection{两著者文献}

引用两个著者的文献时,两个著者之间加\enquote{和}(中文)或
\enquote{and}(英文)。此时可以使用\cs{cite}命令引用文
献，如：

\begin{codetex}{只有两个著者的文献}{code04}
  利用基于Matlab的计算机仿真\cite{郭文彬2006--}，研究了UWB和窄带通讯中
  的信号共存特性\cite{Chiani2009-231-254}。%
\end{codetex}

其排版结果如下：

\begin{center}
  \begin{boxedminipage}{0.9\textwidth}
    \small
    利用基于Matlab的计算机仿真\cite{郭文彬2006--}，研究了UWB和窄带通讯中
      的信号共存特性\cite{Chiani2009-231-254}。%
  \end{boxedminipage}
\end{center}


\subsection{三个以上著者文献}

引用三个以上著者时，只标注第一著者姓名，其后加\enquote{等}(中
文)或\enquote{et al.}(英文)。此时可以使用\cs{cite}命令引用文
献，如：

\begin{codetex}{三个以上著者文献}{code05}
  UML基础和Rose建模教程中详细说明了其基本方法和技巧\cite{蔡敏2006--}。
  你不好好学点\LaTeX{}基本命令还真不行\cite{r9}。%
\end{codetex}

其排版结果如下：

\begin{center}
  \begin{boxedminipage}{0.9\textwidth}
    \small
    UML基础和Rose建模教程中详细说明了其基本方法和技巧\cite{蔡敏2006--}。

    你不好好学点\LaTeX{}基本命令还真不行\cite{r9}。%
  \end{boxedminipage}
\end{center}

\subsection{同一处引用多篇文献}

同一处引用多篇文献时，按著者字母顺序排列，不同著者文
献之间用分号隔开。此时可以使用\cs{cite}命令引用文
献，注意用逗号分开\texttt{citeKey}就好，如：

\begin{codetex}{同一处引用多篇文献}{code06}
  同时引用多个文献\cite{r2,r3,r4,r6}。%
\end{codetex}

其排版结果如下：

\begin{center}
  \begin{boxedminipage}{0.9\textwidth}
    \small
    同时引用多个文献\cite{r2,r3,r4,r6}。%
  \end{boxedminipage}
\end{center}

\subsection{多次引用同一著者的同一文献}

多次引用同一著者的同一文献,在正文中标注著者与出版年,
并在\enquote{()}内以以冒号形式标注引文页码。此时可以使用\cs{parencite}命令引用文
献，注意用可选参数指定引用页码，如：

\begin{codetex}{多次引用同一著者的同一文献}{code07}
  在文献\parencite[20-22]{n21}说了一， 在文献\parencite[55-60]{n21}说了二。%
\end{codetex}

其排版结果如下：

\begin{center}
  \begin{boxedminipage}{0.9\textwidth}
    \small
    在文献\parencite[20-22]{n21}说了一， 在文献\parencite[55-60]{n21}说了二。%
  \end{boxedminipage}
\end{center}

\note{关于著者-出版年样式命令的详细说明可参见胡振震\enquote{符合 GB/T
  7714-2015 标准的 biblatex 参考文献样式}说明中的例12。}

\section{输出参考文献列表}

参考文献列表的输出只需在需要输出文献的位置，使用命令\cs{printbibliography}进行输出即可。

\section{参考文献数据文件准备}

\LaTeX 文档中生成参考文献一般都需要准备一个参考文献数据源文件即
\enquote{*.bib}文件。这一文件内保存有各条参考文献的信息，具体可以参考
biblatex宏包手册和biblatex-gb7714-2015样式包手册\cite{胡振震2019}中关
于域信息录入的说明。

参考文献源文件本质上只是一个文本文件，只是其内容需要遵守BibTeX格式，参
考文献源文件可以有多种生成方式，具体可参考\LaTeX{}文档中文参考文献的
biblatex 解决方案\parencite[2.2节]{胡振震2016}。

\note{学校的参考文献格式并不完全符合\texttt{GB7714-2015}参考文献著录标准，强烈建议学校参考文
  献执行\texttt{GB7714-2015}参考文献著录标准！}

本模板采用由胡振震维护的
\enquote{符合 GB/T 7714-2015 标准的 biblatex 参考文献样式}实现参考文献
的编排\cite{胡振震2019}，其Github链接为
\url{https://github.com/hushidong/biblatex-gb7714-2015}。
大家也可以通过\TeX~Live的 \verb|texdoc gb7714-2015|命令查看其使用说明。

关于著者-出版年样式命令的详细说明可参见胡振震\enquote{符合 GB/T
  7714-2015 标准的 biblatex 参考文献样式}说明中的中的相关内容
\parencite[2.2、2.3节]{胡振震2016}。

\emph{切记：}与图表、公式、定理等一样，请使用专用命令引用并输出参考文
献，以实现参考文献的\emph{自动化}处理，\emph{万万不可}手动编写参考文献！

% 排版参考文献表
% \nocite{*}
\nocite{广西壮族自治区林业厅1993--,r4,张若凌2004--,于潇2012-1518-1523,马克思2013-302-302,张田勤2000--,萧钰2001--,刘加林1993--,张志祥1998--,n42,n43}
\printbibliography[heading=bibintoc]%

\note{此处未按学校规定对参考文献列表进行首行缩进，感觉比首行缩进更好看一些。}

% \newpage
% \begin{refsection}
% \nocite{广西壮族自治区林业厅1993--,r4,张若凌2004--,于潇2012-1518-1523,马克思2013-302-302,张田勤2000--,萧钰2001--,刘加林1993--,张志祥1998--,n42,n43}
% \printbibliography%
% \end{refsection}

\end{document}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: t
%%% End:
